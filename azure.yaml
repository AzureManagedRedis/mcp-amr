# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: mcp-redis
metadata:
  template: mcp-redis@0.0.1-beta

hooks:
  preprovision:
    posix:
      shell: sh
      run: |
        # Handle API Key generation for API-KEY authentication
        # This runs BEFORE provisioning so keys are available as Bicep parameters
        AUTH_METHOD=$(azd env get-value MCP_AUTH_METHOD 2>/dev/null || echo "NO-AUTH")
        
        if [ "$AUTH_METHOD" = "API-KEY" ]; then
            # Check if API keys were already provided
            # Check exit code to determine if key exists
            if azd env get-value MCP_API_KEYS >/dev/null 2>&1; then
                EXISTING_KEYS=$(azd env get-value MCP_API_KEYS 2>/dev/null)
            else
                EXISTING_KEYS=""
            fi
            
            if [ -z "$EXISTING_KEYS" ]; then
                echo "üîê Generating API keys for MCP authentication..."
                
                # Generate two secure API keys
                API_KEY_1=$(openssl rand -base64 32)
                API_KEY_2=$(openssl rand -base64 32)
                
                # Set the generated keys in the environment
                azd env set MCP_API_KEYS "${API_KEY_1},${API_KEY_2}"
                
                echo ""
                echo "üéâ API Keys generated successfully!"
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo "üìã Your MCP Server API Keys (save these securely):"
                echo ""
                echo "   üîë API Key 1: ${API_KEY_1}"
                echo "   üîë API Key 2: ${API_KEY_2}"
                echo ""
                echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                echo ""
                echo "üí° Usage examples:"
                echo "   ‚Ä¢ HTTP Header:  X-API-Key: ${API_KEY_1}"
                echo "   ‚Ä¢ Query Parameter: ?api_key=${API_KEY_1}"
                echo ""
                echo "‚ö†Ô∏è  Important: Store these keys securely. They will not be shown again."
                echo "   You can retrieve them later with: azd env get-value MCP_API_KEYS"
                echo ""
            else
                echo "‚úÖ Using existing API keys from environment"
            fi
        fi
      continueOnError: false
      interactive: true
    
    windows:
      shell: pwsh
      run: |
        # Handle API Key generation for API-KEY authentication
        # This runs BEFORE provisioning so keys are available as Bicep parameters
        $AUTH_METHOD = azd env get-value MCP_AUTH_METHOD 2>$null
        if (-not $AUTH_METHOD) { $AUTH_METHOD = "NO-AUTH" }
        
        if ($AUTH_METHOD -eq "API-KEY") {
            # Check if API keys were already provided
            # Check exit code to determine if key exists
            $EXISTING_KEYS = ""
            azd env get-value MCP_API_KEYS >$null 2>&1
            if ($LASTEXITCODE -eq 0) {
                $EXISTING_KEYS = azd env get-value MCP_API_KEYS 2>$null
            }
            
            if (-not $EXISTING_KEYS -or $EXISTING_KEYS -eq "") {
                Write-Host "üîê Generating API keys for MCP authentication..."
                
                # Generate two secure API keys using .NET cryptography
                $API_KEY_1 = [Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))
                $API_KEY_2 = [Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))
                
                # Set the generated keys in the environment
                azd env set MCP_API_KEYS "${API_KEY_1},${API_KEY_2}"
                
                Write-Host ""
                Write-Host "üéâ API Keys generated successfully!"
                Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                Write-Host "üìã Your MCP Server API Keys (save these securely):"
                Write-Host ""
                Write-Host "   üîë API Key 1: ${API_KEY_1}"
                Write-Host "   üîë API Key 2: ${API_KEY_2}"
                Write-Host ""
                Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                Write-Host ""
                Write-Host "üí° Usage examples:"
                Write-Host "   ‚Ä¢ HTTP Header:  X-API-Key: ${API_KEY_1}"
                Write-Host "   ‚Ä¢ Query Parameter: ?api_key=${API_KEY_1}"
                Write-Host ""
                Write-Host "‚ö†Ô∏è  Important: Store these keys securely. They will not be shown again."
                Write-Host "   You can retrieve them later with: azd env get-value MCP_API_KEYS"
                Write-Host ""
            } else {
                Write-Host "‚úÖ Using existing API keys from environment"
            }
        }
      continueOnError: false
      interactive: true

  postprovision:
    posix:
      shell: sh
      run: |
        # Generate image tag with timestamp and git hash
        IMAGE_TAG="$(date +%Y%m%d-%H%M%S)"
        git rev-parse --short HEAD &> /dev/null && IMAGE_TAG="${IMAGE_TAG}-$(git rev-parse --short HEAD)"
        
        # Get Azure resource info
        ACR_NAME=$(azd env get-value AZURE_CONTAINER_REGISTRY_NAME)
        CONTAINER_APP_NAME=$(azd env get-value AZURE_CONTAINER_APP_NAME)
        RESOURCE_GROUP=$(azd env get-value AZURE_RESOURCE_GROUP)
        
        # Build and push to ACR
        echo "Building and pushing redis-mcp-server:${IMAGE_TAG}..."
        az acr build --registry "$ACR_NAME" \
          --image "redis-mcp-server:${IMAGE_TAG}" \
          --image "redis-mcp-server:latest" \
          --platform linux/amd64 . --output table
        
        # Update Container App
        echo "Updating Container App..."
        ACR_LOGIN_SERVER=$(az acr show --name "$ACR_NAME" --query loginServer -o tsv)
        az containerapp update --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP" \
          --image "${ACR_LOGIN_SERVER}/redis-mcp-server:${IMAGE_TAG}" --output table
        
        # Show deployment info
        FQDN=$(azd env get-value AZURE_CONTAINER_APP_FQDN)
        echo "‚úÖ Deployed: redis-mcp-server:${IMAGE_TAG}"
        echo "üìç MCP Server: https://${FQDN}/message"
        echo "üîç Health check: https://${FQDN}/health"
      continueOnError: false
      interactive: true
    
    windows:
      shell: pwsh
      run: |
        # Generate image tag with timestamp and git hash
        $IMAGE_TAG = Get-Date -Format "yyyyMMdd-HHmmss"
        if (git rev-parse --short HEAD 2>$null) {
          $IMAGE_TAG = "${IMAGE_TAG}-$(git rev-parse --short HEAD)"
        }
        
        # Get Azure resource info
        $ACR_NAME = azd env get-value AZURE_CONTAINER_REGISTRY_NAME
        $CONTAINER_APP_NAME = azd env get-value AZURE_CONTAINER_APP_NAME
        $RESOURCE_GROUP = azd env get-value AZURE_RESOURCE_GROUP
        
        # Build and push to ACR
        Write-Host "Building and pushing redis-mcp-server:${IMAGE_TAG}..."
        az acr build --registry "$ACR_NAME" `
          --image "redis-mcp-server:${IMAGE_TAG}" `
          --image "redis-mcp-server:latest" `
          --platform linux/amd64 . --output table
        
        # Update Container App
        Write-Host "Updating Container App..."
        $ACR_LOGIN_SERVER = az acr show --name "$ACR_NAME" --query loginServer -o tsv
        az containerapp update --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP" `
          --image "${ACR_LOGIN_SERVER}/redis-mcp-server:${IMAGE_TAG}" --output table
        
        # Show deployment info
        $FQDN = azd env get-value AZURE_CONTAINER_APP_FQDN
        Write-Host "‚úÖ Deployed: redis-mcp-server:${IMAGE_TAG}"
        Write-Host "üìç MCP Server: https://${FQDN}/message"
        Write-Host "üîç Health check: https://${FQDN}/health"
      continueOnError: false
      interactive: true
