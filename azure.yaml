# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: mcp-redis
metadata:
  template: mcp-redis@0.0.1-beta

hooks:
  postprovision:
    posix:
      shell: sh
      run: |
        # Generate image tag with timestamp and git hash
        IMAGE_TAG="$(date +%Y%m%d-%H%M%S)"
        git rev-parse --short HEAD &> /dev/null && IMAGE_TAG="${IMAGE_TAG}-$(git rev-parse --short HEAD)"
        
        # Get Azure resource info
        ACR_NAME=$(azd env get-value AZURE_CONTAINER_REGISTRY_NAME)
        CONTAINER_APP_NAME=$(azd env get-value AZURE_CONTAINER_APP_NAME)
        RESOURCE_GROUP=$(azd env get-value AZURE_RESOURCE_GROUP)
        
        # Build and push to ACR
        echo "Building and pushing redis-mcp-server:${IMAGE_TAG}..."
        az acr build --registry "$ACR_NAME" \
          --image "redis-mcp-server:${IMAGE_TAG}" \
          --image "redis-mcp-server:latest" \
          --platform linux/amd64 . --output table
        
        # Update Container App
        echo "Updating Container App..."
        ACR_LOGIN_SERVER=$(az acr show --name "$ACR_NAME" --query loginServer -o tsv)
        az containerapp update --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP" \
          --image "${ACR_LOGIN_SERVER}/redis-mcp-server:${IMAGE_TAG}" --output table
        
        # Show deployment info
        FQDN=$(azd env get-value AZURE_CONTAINER_APP_FQDN)
        echo "‚úÖ Deployed: redis-mcp-server:${IMAGE_TAG}"
        echo "üìç MCP Server: https://${FQDN}/message"
        echo "üîç Health check: https://${FQDN}/health"
      continueOnError: false
      interactive: true
    
    windows:
      shell: pwsh
      run: |
        # Generate image tag with timestamp and git hash
        $IMAGE_TAG = Get-Date -Format "yyyyMMdd-HHmmss"
        if (git rev-parse --short HEAD 2>$null) {
          $IMAGE_TAG = "${IMAGE_TAG}-$(git rev-parse --short HEAD)"
        }
        
        # Get Azure resource info
        $ACR_NAME = azd env get-value AZURE_CONTAINER_REGISTRY_NAME
        $CONTAINER_APP_NAME = azd env get-value AZURE_CONTAINER_APP_NAME
        $RESOURCE_GROUP = azd env get-value AZURE_RESOURCE_GROUP
        
        # Build and push to ACR
        Write-Host "Building and pushing redis-mcp-server:${IMAGE_TAG}..."
        az acr build --registry "$ACR_NAME" `
          --image "redis-mcp-server:${IMAGE_TAG}" `
          --image "redis-mcp-server:latest" `
          --platform linux/amd64 . --output table
        
        # Update Container App
        Write-Host "Updating Container App..."
        $ACR_LOGIN_SERVER = az acr show --name "$ACR_NAME" --query loginServer -o tsv
        az containerapp update --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP" `
          --image "${ACR_LOGIN_SERVER}/redis-mcp-server:${IMAGE_TAG}" --output table
        
        # Show deployment info
        $FQDN = azd env get-value AZURE_CONTAINER_APP_FQDN
        Write-Host "‚úÖ Deployed: redis-mcp-server:${IMAGE_TAG}"
        Write-Host "üìç MCP Server: https://${FQDN}/message"
        Write-Host "üîç Health check: https://${FQDN}/health"
      continueOnError: false
      interactive: true
