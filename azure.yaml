# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: mcp-redis
metadata:
  template: mcp-redis@0.0.1-beta

# Define service for azd deploy to work
services:
  redis-mcp:
    project: .
    language: python
    host: containerapp

hooks:
  postdeploy:
    posix:
      shell: sh
      run: |
        # Build and push container image using ACR
        echo "Building and pushing container image..."
        IMAGE_TAG=$(date +%Y%m%d-%H%M%S)
        if git rev-parse --short HEAD &> /dev/null; then
          GIT_HASH=$(git rev-parse --short HEAD)
          IMAGE_TAG="${IMAGE_TAG}-${GIT_HASH}"
        fi
        
        ACR_NAME=$(azd env get-value AZURE_CONTAINER_REGISTRY_NAME)
        CONTAINER_APP_NAME=$(azd env get-value AZURE_CONTAINER_APP_NAME)
        RESOURCE_GROUP=$(azd env get-value AZURE_RESOURCE_GROUP)
        
        echo "Building image with tag: ${IMAGE_TAG}"
        az acr build \
          --registry "$ACR_NAME" \
          --image "redis-mcp-server:${IMAGE_TAG}" \
          --image "redis-mcp-server:latest" \
          --platform linux/amd64 \
          . \
          --output table
        
        # Update container app with new image
        echo "Updating Container App with new image..."
        ACR_LOGIN_SERVER=$(az acr show --name "$ACR_NAME" --query loginServer -o tsv)
        az containerapp update \
          --name "$CONTAINER_APP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --image "${ACR_LOGIN_SERVER}/redis-mcp-server:${IMAGE_TAG}" \
          --output table
        
        echo "‚úÖ Deployment complete! Image: redis-mcp-server:${IMAGE_TAG}"
        echo "üìç MCP Server URL: https://$(azd env get-value AZURE_CONTAINER_APP_FQDN)/message"
        echo "üîç Health check: https://$(azd env get-value AZURE_CONTAINER_APP_FQDN)/health"
      continueOnError: false
      interactive: true
    
    windows:
      shell: pwsh
      run: |
        # Build and push container image using ACR
        Write-Host "Building and pushing container image..."
        $IMAGE_TAG = Get-Date -Format "yyyyMMdd-HHmmss"
        if (git rev-parse --short HEAD 2>$null) {
          $GIT_HASH = git rev-parse --short HEAD
          $IMAGE_TAG = "${IMAGE_TAG}-${GIT_HASH}"
        }
        
        $ACR_NAME = azd env get-value AZURE_CONTAINER_REGISTRY_NAME
        $CONTAINER_APP_NAME = azd env get-value AZURE_CONTAINER_APP_NAME
        $RESOURCE_GROUP = azd env get-value AZURE_RESOURCE_GROUP
        
        Write-Host "Building image with tag: ${IMAGE_TAG}"
        az acr build `
          --registry "$ACR_NAME" `
          --image "redis-mcp-server:${IMAGE_TAG}" `
          --image "redis-mcp-server:latest" `
          --platform linux/amd64 `
          . `
          --output table
        
        # Update container app with new image
        Write-Host "Updating Container App with new image..."
        $ACR_LOGIN_SERVER = az acr show --name "$ACR_NAME" --query loginServer -o tsv
        az containerapp update `
          --name "$CONTAINER_APP_NAME" `
          --resource-group "$RESOURCE_GROUP" `
          --image "${ACR_LOGIN_SERVER}/redis-mcp-server:${IMAGE_TAG}" `
          --output table
        
        Write-Host "‚úÖ Deployment complete! Image: redis-mcp-server:${IMAGE_TAG}"
        $FQDN = azd env get-value AZURE_CONTAINER_APP_FQDN
        Write-Host "üìç MCP Server URL: https://${FQDN}/message"
        Write-Host "üîç Health check: https://${FQDN}/health"
      continueOnError: false
      interactive: true
